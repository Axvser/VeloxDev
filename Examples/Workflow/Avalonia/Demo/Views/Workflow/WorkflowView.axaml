<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
			 x:Class="Demo.WorkflowView"
			 xmlns:local="using:Demo"
			 xmlns:vm="using:Demo.ViewModels"
			 xmlns:workflow="using:VeloxDev.Core.Interfaces.WorkflowSystem"
			 x:DataType="vm:TreeViewModel"
			 PointerReleased="OnPointerReleased"
			 PointerMoved="OnPointerMoved">

	<!-- 模板选择 -->
	<UserControl.DataTemplates>
		<!-- 节点模板 -->
		<DataTemplate DataType="vm:NodeViewModel">
			<local:NodeView Width="{Binding Size.Width}"
							Height="{Binding Size.Height}"
							RenderTransform="{Binding $parent[local:WorkflowView].CanvasTransform}"/>
		</DataTemplate>
		<DataTemplate DataType="vm:ControllerViewModel">
			<local:ControllerView Width="{Binding Size.Width}"
								  Height="{Binding Size.Height}"
								  RenderTransform="{Binding $parent[local:WorkflowView].CanvasTransform}"/>
		</DataTemplate>
		<!-- 连接线模板 -->
		<DataTemplate DataType="workflow:IWorkflowLinkViewModel">
			<local:BezierCurveView StartLeft="{Binding Sender.Anchor.Left}"
								   StartTop="{Binding Sender.Anchor.Top}"
								   EndLeft="{Binding Receiver.Anchor.Left}"
								   EndTop="{Binding Receiver.Anchor.Top}"
								   CanRender="{Binding IsVisible}"
								   Width="{Binding $parent[Canvas].Bounds.Width}"
								   Height="{Binding $parent[Canvas].Bounds.Height}"
								   RenderTransform="{Binding $parent[local:WorkflowView].CanvasTransform}"/>
		</DataTemplate>
	</UserControl.DataTemplates>

	<Grid ColumnDefinitions="2*,auto,8*">
		<Grid Grid.Column="0">
			<ScrollViewer>
				<StackPanel Orientation="Vertical">
					<TextBlock Text="{Binding Layout}" />
					<Button Content="Undo" Width="100" Height="50" Command="{Binding UndoCommand}" />
					<Button Content="Redo" Width="100" Height="50" Command="{Binding RedoCommand}" />
					<Button Content="Save" Width="100" Height="50" Click="SaveWorkflow" />
					<Button Content="Select" Width="100" Height="50" Click="SelectWorkflow" />
					<Button Content="Simulate" Width="100" Height="50" Click="SimulateData" />
					<Button Content="左延申" Click="Button_Click"/>
					<Button Content="上延申" Click="Button_Click1"/>
					<Button Content="右延申" Click="Button_Click2"/>
					<Button Content="下延申" Click="Button_Click3"/>
					<Button Content="放大" Click="Button_Click4"/>
					<Button Content="缩小" Click="Button_Click5"/>
					<Button Content="GC" Click="Button_Click7"/>
					<Button Content="虚拟化" Click="Button_Click6"/>
					<TextBlock Text="节点总数：" />
					<TextBlock Text="{Binding Nodes.Count}"/>
					<TextBlock Text="数据层虚拟化耗时：" />
					<TextBlock x:Name="VMTime"/>
					<TextBlock Text="UI层同步耗时：" />
					<TextBlock x:Name="VTime"/>
					<TextBlock Text="可见节点数：" />
					<TextBlock Text="{Binding VisibleNodes.Count}" />
					<local:Rocker x:Name="PART_ROCKER" Width="100" Height="100" Foreground="Lime"/>
				</StackPanel>
			</ScrollViewer>
		</Grid>

		<GridSplitter Grid.Column="1" Width="5" Background="Gray"/>

		<Grid Grid.Column="2">
			<Border BorderBrush="White" BorderThickness="1" CornerRadius="3">
				<ScrollViewer HorizontalScrollBarVisibility="Auto"
							  x:Name="Root_ScrollViewer">
					<Canvas Width="{Binding Layout.ActualSize.Width}"
							Height="{Binding Layout.ActualSize.Height}"
							HorizontalAlignment="Left"
							VerticalAlignment="Top"
							RenderTransform="{Binding $parent[local:WorkflowView].GlobalScale}"
							x:Name="Root_Canvas">
						<!-- 已挂载节点 -->
						<ItemsControl ItemsSource="{Binding VisibleNodes}"
									  ZIndex="0">
							<ItemsControl.ItemsPanel>
								<ItemsPanelTemplate>
									<Canvas Width="{Binding Layout.ActualSize.Width}"
											Height="{Binding Layout.ActualSize.Height}"/>
								</ItemsPanelTemplate>
							</ItemsControl.ItemsPanel>
							<ItemsControl.ItemContainerTheme>
								<ControlTheme TargetType="ContentPresenter" x:DataType="workflow:IWorkflowNodeViewModel">
									<Setter Property="Canvas.Left" Value="{Binding Anchor.Left}" />
									<Setter Property="Canvas.Top" Value="{Binding Anchor.Top}" />
									<Setter Property="Canvas.ZIndex" Value="{Binding Anchor.Layer}" />
								</ControlTheme>
							</ItemsControl.ItemContainerTheme>
						</ItemsControl>
						<!-- 已建立连接线 -->
						<ItemsControl ItemsSource="{Binding Links}"
									  ZIndex="-1">
							<ItemsControl.ItemsPanel>
								<ItemsPanelTemplate>
									<Canvas Width="{Binding Layout.ActualSize.Width}"
											Height="{Binding Layout.ActualSize.Height}"/>
								</ItemsPanelTemplate>
							</ItemsControl.ItemsPanel>
						</ItemsControl>
						<!-- 临时连接线 -->
						<Canvas Width="{Binding Layout.ActualSize.Width}"
								Height="{Binding Layout.ActualSize.Height}">
							<local:BezierCurveView x:DataType="workflow:IWorkflowLinkViewModel"
												   ZIndex="-2"
												   DataContext="{Binding VirtualLink}"
												   StartLeft="{Binding Sender.Anchor.Left}"
												   StartTop="{Binding Sender.Anchor.Top}"
												   EndLeft="{Binding Receiver.Anchor.Left}"
												   EndTop="{Binding Receiver.Anchor.Top}"
												   CanRender="{Binding IsVisible}"
												   Width="{Binding $parent[Canvas].Bounds.Width}"
												   Height="{Binding $parent[Canvas].Bounds.Height}"
												   IsVirtual="True"
												   RenderTransform="{Binding $parent[local:WorkflowView].CanvasTransform}"/>
						</Canvas>
					</Canvas>
				</ScrollViewer>
			</Border>
		</Grid>
	</Grid>
</UserControl>
